# Техническое задание (ТЗ)

## «REST API банковского сервиса на Go 1.23+»

---

### 1. Цель проекта

Создать удобное и безопасное серверное приложение для доступа клиентов к банковским услугам через REST API. Сервис должен поддерживать работу с пользователями, банковскими счётами, картами, переводами, кредитами и аналитикой, а также интеграции с внешними системами (ЦБ РФ и SMTP).

---

### 2. Технологический стек

| Слой / задача              | Инструменты / библиотеки                         |
| -------------------------- | ------------------------------------------------ |
| **Язык**                   | Go ≥ 1.23                                        |
| **Маршрутизация**          | `github.com/gorilla/mux`                         |
| **БД**                     | PostgreSQL 17 + расширение **pgcrypto**          |
| **Драйвер БД**             | `github.com/lib/pq` (или `pgx`)                  |
| **Аутентификация**         | `github.com/golang-jwt/jwt/v5`                   |
| **Логирование**            | `github.com/sirupsen/logrus`                     |
| **Шифрование/хеширование** | `bcrypt`, `HMAC-SHA256`, PGP (через pgcrypto)    |
| **Email**                  | `gopkg.in/gomail.v2`                             |
| **SOAP → XML**             | `github.com/beevik/etree` (парсинг ответа ЦБ РФ) |
| **Планировщик задач**      | стандартный `time.Ticker` / cron-библиотека      |

---

### Функциональные требования

#### 4.1 Пользователи

* **POST /register** — регистрация (уникальные *email* и *username*)
* **POST /login** — аутентификация (JWT сроком 24 ч)

#### 4.2 Счета

* **POST /accounts** — создать счёт
* **POST /transfer** — перевод между счетами
* **PATCH /accounts/{id}/balance** — пополнение/списание

#### 4.3 Карты

* **POST /cards** — выпуск виртуальной карты

  * номер генерируется по алгоритму Луна
  * номер и срок хранятся **зашифрованными PGP**
  * CVV — **bcrypt-хеш**
* **GET /cards/{id}** — расшифровка и отдача владельцу
* **POST /payments** — оплата картой

#### 4.4 Кредиты

* **POST /credits** — оформить кредит (аннуитет)
* **GET /credits/{id}/schedule** — платежный график
* **Автоматическое списание** — шедулер каждые N часов

  * если средств недостаточно → штраф +10 %

#### 4.5 Аналитика

* **GET /analytics** — доходы/расходы за месяц, кредитная нагрузка
* **GET /accounts/{id}/predict?days=N** — прогноз баланса (≤ 365 дней)

---

### 5. Эндпоинты (итоговая карта)

| Метод | Путь                   | Описание              | Доступ    |
| ----- | ---------------------- | --------------------- | --------- |
| POST  | /register              | Регистрация           | Публичный |
| POST  | /login                 | Логин (JWT)           | Публичный |
| POST  | /accounts              | Создать счёт          | JWT       |
| PATCH | /accounts/{id}/balance | Пополнение/списание   | JWT       |
| POST  | /transfer              | Перевод между счетами | JWT       |
| POST  | /cards                 | Выпуск карты          | JWT       |
| GET   | /cards/{id}            | Просмотр карты        | JWT       |
| POST  | /payments              | Оплата картой         | JWT       |
| POST  | /credits               | Оформление кредита    | JWT       |
| GET   | /credits/{id}/schedule | График платежей       | JWT       |

*JWT-middleware* блокирует неавторизованные запросы и передаёт `userID` в контекст.

---

### 6. Модель данных (минимально необходимое)

| Таблица                | Ключевые поля                                                                                   |
| ---------------------- | ----------------------------------------------------------------------------------------------- |
| **users**              | id (PK), email (UNIQUE), username (UNIQUE), password\_hash, created\_at                         |
| **accounts**           | id, user\_id (FK), balance, currency='RUB', created\_at                                         |
| **cards**              | id, user\_id (FK), card\_number (bytea PGP), expire (bytea PGP), cvv\_hash, created\_at         |
| **transactions**       | id, account\_id (FK), amount, type \[DEBIT/CREDIT], status, created\_at                         |
| **credits**            | id, account\_id (FK), principal, interest\_rate, term\_months, start\_date, status, created\_at |
| **payment\_schedules** | id, credit\_id (FK), due\_date, amount, paid, created\_at                                       |

> **Расширение pgcrypto** требуется для функций PGP-шифрования/дешифрования прямо в SQL.

---

### 7. Безопасность

| Объект                  | Метод защиты                                |
| ----------------------- | ------------------------------------------- |
| Пароли                  | `bcrypt` (cost 12+)                         |
| JWT                     | HMAC-SHA256, секрет `JWT_SECRET`, TTL 24 ч  |
| Номер/срок карты        | PGP-симметричное шифрование (pgcrypto)      |
| CVV                     | `bcrypt`-хеш                                |
| Целостность данных карт | HMAC-SHA256                                 |
| Доступ к ресурсам       | Проверка `userID` vs владение счётом/картой |

---

### 8. Внешние интеграции

| Система   | Назначение                                           | Технология                                                                            |
| --------- | ---------------------------------------------------- | ------------------------------------------------------------------------------------- |
| **ЦБ РФ** | Получение ключевой ставки                            | SOAP ➜ `https://www.cbr.ru/DailyInfoWebServ/DailyInfo.asmx` (парсинг XML через etree) |
| **SMTP**  | Email-уведомления (регистрация, списания, просрочки) | `gomail.v2`                                                                           |

---

### 9. Нефункциональные требования

* **Производительность**: до 100 RPS на одном экземпляре.
* **Логирование**: уровни DEBUG/INFO/WARN/ERROR (logrus, JSON-формат).
* **Покрытие тестами**: ≥ 70 % сервисного уровня.
* **Документация API**: OpenAPI 3 (Swagger UI).
* **CI/CD**: linters (`golangci-lint`), тесты, образ Docker.
* **Ограничения**: поддерживается только валюта **RUB**.

---

### 10. Планировщик (Scheduler)

* Запуск задачи каждые **12 часов**:

  1. Проверка `payment_schedules` на сегодня/просрочку.
  2. Попытка списать `amount` со счёта.
  3. При недостатке средств → отметка просрочки + увеличение суммы на 10 %.
* Реализация: отдельный goroutine + канал остановки или cron-библиотека.

---